---
title             : "Still suspicious: The suspicious coincidence effect revisited"
shorttitle        : "The suspicious coincidence effect revisited"

author:  
  - name          : "Molly L. Lewis"
    affiliation   : "1,2"
    corresponding : yes    # Define only one corresponding author
    email         : "mollylewis@uchicago.edu"
  - name          : "Michael C. Frank"
    affiliation   : "3"
    email         : "mcfrank@stanford.edu"

affiliation:
  - id            : "1"
    institution   : "Computation Institute, University of Chicago"
  - id            : "2"
    institution   : "Department of Psychology, University of Wisconsin, Madison"
  - id            : "3"
    institution   : "Department of Psychology, Stanford University"

note: |  
  $^*$To whom correspondence should be addressed. E-mail: mollylewis@uchicago.edu


abstract: |
  Enter abstract here. Each new line herein must be indented, like this line.
  
keywords          : "keywords"
wordcount         : "X"

bibliography      : ["r-references.bib"]

figsintext        : yes
figurelist        : no
tablelist         : no
footnotelist      : no
lineno            : no

lang              : "english"
class             : "man"
output            : papaja::apa6_pdf
---

```{r load_packages, include = FALSE}
library(papaja)
library(rmarkdown)
library(broom)
library(tidyverse) 
library(langcog)
library(jsonlite)
library(stringr)
library(forcats)
library(compute.es)
library(metafor)
library(knitr)
library(kableExtra)

knitr::opts_chunk$set(warning = FALSE, 
                      message = FALSE, 
                      cache = FALSE, 
                      fig.pos = "T!")
```


## Intro

What is the suspicious coincidence effect?

[@spencer2011learning; @xu2007; @xu2007word]

Why is it important?

Spencer et al. paper

Methodological differences:

* simultaneous vs. sequential
* 3-1 vs. 1-3
* blocking
* same label vs. different label

other evidence relevant on this replication

Our current paper reports 12 experiments, 10 of which were pre-registered. We recover the suspicious coincidence effect with a large effect size in both sequential and simultaneous presentation conditions. The effect only occurs, however, in experiments where the trial with one exemplar is presented *before* the key trial with three subordinate-consistent exemplars (the "suspicious coincidence"). We attribute this difference to participants' awareness of the possibility of subordinate generalizations following the three-exemplar trial; in these conditions, we see a high level of subordinate generalizations even for the one-exemplar trial (leading to the absence of a difference between conditions). In sum, and contra SPSS, the "suspicious coincidence" effect is robust to sequential presentation. The effect is sensitive to some features of the general experimental context, however, suggesting a potential interpretation in terms of the pragmatics of the task. 


# Methods
```{r read_in_anon_data}
files <- dir("../data/munged_data/")[-1]
  
all_d <- data.frame()
for (i in 1:length(files)[1]) {
    s <- read.csv(paste0("../data/munged_data/", files[i]))
    all_d <- bind_rows(all_d, data.frame(s))
}

exp_key <- read_csv("../analysis/experiment_key.csv") %>%
              mutate(order = gsub("\"", "", order))# this is because excel is dumb, grrr
```

We report how we determined our sample size, all data exclusions (if any), all manipulations, and all measures in the study.

## Participants
50 participants were recruited on Amazon Mechanical Turk for each of our 12 experiments (N = 600). Participants were paid 40 cents for their participation

Our sample size was determined based on a pre-registered power calculation using a meta-anayltic estimate of the effect size from studies conducted by XT and SPSS (see SI for more details). The chosen sample size was approximately twice the estimated sample size necessary to obtain a power of 1. 

* Exclusions?


```{r, include = F}
# Preregistration: https://osf.io/6xa44/register/5771ca429ad5a1020de2872e
# pre-reg power calculation: 
```


## Stimuli
Our stimuli closely resembled that of XT and SPSS. The pictures consisted of three sets of 15 photos from different basic level categories (vegetables, vehicles and animals). Within each category, five were subordinate exemplars (e.g. green pepper), four were basic level exemplars (e.g. peppers), and six were superordinate exemplars (e.g. vegetables). The exemplars were divided into a learning and test set.  

Novel labels 

## Procedure

### Manipulations:
(1) Timing
(2) Order
(3) Blocking
(4) Labels

## Data analysis

We used `r cite_r("r-references.bib")` for all our analyses.


# Results

```{r get_means}
# remap condition values and select relevant conditions
all_d_clean <- all_d %>%
      mutate(condition = as.factor(condition),
             exp = as.character(exp),
             condition = fct_recode(condition,
                                     three_basic = "3bas",
                                     three_subordinate = "3sub",
                                     three_superordinate = "3sup")) %>%
      filter(condition == "one" | condition == "three_subordinate") %>%
      select(exp, everything())

# get condition means and CIs, and join in experiment values
all_ms <- all_d_clean %>%
  gather(variable, value, c(prop_sub, prop_bas, prop_sup)) %>%
  mutate(value = as.numeric(value)) %>%
  filter(variable == "prop_bas") %>%
  group_by(condition, exp, subids) %>%
  summarize(value = mean(value)) %>%
  group_by(condition, exp) %>%
  # multi_boot_standard(column = "value")  %>%
  summarise(mean = mean(value), 
            error = qt(0.975,df=n()-1)*sd(value)/sqrt(n()),
            ci_lower = mean - error,# FIXME to bootstrap
            ci_upper = mean + error) %>%
  left_join(exp_key)
```

```{r fig.height = 3, fig.cap = "Mean proportion generalization to basic level exemplars in the one (green) and three (pink) subordinate exemplar conditions for all 12 of our experiments. Each facet corresponds to a pairing of presentation timing (sequential vs. simultaneous) and trial order (1-3 vs. 3-1). Error bars are bootstrapped 95% confidence intervals."}

all_ms_recoded <- all_ms %>%
   mutate(exp_recoded = fct_relevel(exp_recoded, as.character(seq(1:12))),
            condition2 = paste(timing, order),
            condition2 = fct_recode(condition2, "sequential \n1-3 order" = "sequential 1-3", 
                                                   "simultaneous \n1-3 order" = "simultaneous 1-3",
                                                   "sequential \n3-1 order" = "sequential 3-1",
                                                   "simultaneous \n3-1 order" = "simultaneous 3-1"),
            condition2 = fct_relevel(condition2, c("sequential \n1-3 order", "simultaneous \n1-3 order",
                                                   "sequential \n3-1 order", "simultaneous \n3-1 order")))
            
ggplot(all_ms_recoded, 
       aes(x = exp_recoded, y = mean, group = condition, fill = condition)) +
  geom_bar(position = "dodge", stat = "identity") +
  geom_linerange(aes(ymin = ci_lower, 
                     ymax = ci_upper), 
                 position = position_dodge(width = .9)) +
  facet_grid(. ~ condition2, scales = "free", drop = TRUE,  space = "free_x") +
  scale_fill_discrete(labels = c("three", "one")) +
  ylim(0, 1) +
  ylab("Prop. basic-level choices") +
  xlab("Experiment") +
  theme(strip.text = element_text(size = 10),
        strip.background = element_rect(fill = "grey"),
        legend.position = c(0.92, 0.79),
        legend.text = element_text(size = 9),
        legend.title = element_text(size = 10),
        legend.key.size = unit(.5, "cm"),
        legend.background =  element_rect(color = "black", size = 0.5))
```


```{r get_es}
# get subject level means
all_ms_subj <- all_d_clean %>%
  left_join(exp_key %>% select(exp, exp_recoded)) %>%
  select(-exp) %>%
  gather(variable, value, c(prop_sub, prop_bas, prop_sup)) %>%
  group_by(condition, variable, exp_recoded, subids) %>%
  mutate(value = as.numeric(value)) %>%
  summarize(value = mean(value)) %>%
  filter(condition == "one" | condition == "three_subordinate", variable == 'prop_bas') %>%
  spread(condition, value) %>%
  ungroup() %>%
  select(-variable)

# get effect sizes
LF_means <- all_ms_subj %>%
  group_by(exp_recoded) %>%
  summarize(m_one = mean(one),
            sd_one = sd(one),
            m_3sub = mean(three_subordinate),
            sd_3sub = sd(three_subordinate),
            n = n())

LF_effect_sizes <- LF_means %>%
  do(data.frame(d = mes(.$m_one, .$m_3sub, .$sd_one,
                     .$sd_3sub, .$n, .$n, verbose = F)$d,
               d_var = mes(.$m_one, .$sd_3sub, .$sd_one,
                    .$sd_3sub, .$n, .$n, verbose = F)$var.d)) %>%
  mutate(high = d + (1.96*d_var),
         low = d - (1.96*d_var),
         es_type = "nonpaired",
         exp_recoded = LF_means$exp_recoded) %>%
  left_join(LF_means %>% select(exp_recoded, n)) %>%
  select(exp_recoded, n, everything())
```

```{r}
exp_table <- exp_key %>%
  slice(1:12) %>%
  left_join(LF_effect_sizes) %>%
  mutate(d_string = paste0(d," [", round(low,2), ", ", round(high, 2) , "]"),
         direct_replication_of_string = ifelse(is.na(direct_replication_of),
                                              "", direct_replication_of),
         timing = str_replace_all(timing, "sequential", "seq."),
         timing = str_replace_all(timing, "simultaneous", "simult."),
         one_3sub_label = str_replace_all(one_3sub_label, "different", "diff."),
         exp_recoded = as.numeric(exp_recoded)) %>%
  select(exp_recoded, n, timing, order, blocking, 
         one_3sub_label, d_string, direct_replication_of_string) %>%
  arrange(exp_recoded)

# caption = "Summary of our 10 experiments. N = sample size; Timing = presentation timing (simultaneous or sequential); Order = relative ordering of 1 vs. 3 subordinate trials; Blocking = trials blocked by category or pseudorandom; Label = same or different label used in 1 and 3 trials; Effect size = Cohen's d [95% CI]; Orginal Exp. = Corresponding prior experiment.",

kable(exp_table, align = c('c', 'r', 'r', 'r', "r", "r", "r", "r"), 
      #col.names = c("Experiment \nNum.", "N", "Timing", "Condition \nOrder",
      #              "Trial \nOrder", "Label", "Effect Size"),
      caption = "Summary of our 10 experiments.",
      col.names = c("Exp.", "N", "Timing", "Order",
                     "Blocking", "Label", "Effect Size", "Original \nExp."),
      format = "latex", booktabs = TRUE) %>%
    kable_styling(font_size = 12) %>%
    add_header_above(c(" " = 2, "Manipulations" = 4, " ")) %>%
    add_footnote("N = sample size; Timing = presentation timing (sequential or simultaneous); Order = relative ordering of 1 and 3 subordinate trials; Blocking = trials blocked by category or pseudorandom; Label = same or different label in 1 and 3 trials; Effect size = Cohen's d [95% CI]; Original Exp.\ = corresponding experiments from prior literature.", notation = "number")

```

```{r get_MA_es}
literature_effect_sizes <- read_csv("../data/literature_ES.csv") # see ../analysis/get_literature_ES.R

all_es <- literature_effect_sizes %>%
           bind_rows(LF_effect_sizes) %>%
           left_join(exp_key) %>%
           mutate(source = ifelse(str_detect(exp_recoded, "XT"), "XT2007a", 
                               ifelse(str_detect(exp_recoded, "SPSS"),
                                      "SPSS2011", "LF")), 
                   source = fct_relevel(source, "XT2007a","SPSS2011","LF"),
                   timing = fct_relevel(timing,"simultaneous", "sequential")) %>%
            mutate(source = as.numeric(source))

seq13 <- rma(d, d_var, dat = filter(all_es, timing == "sequential", order == "1-3"))
seq31 <- rma(d, d_var, dat = filter(all_es, timing == "sequential", order == "3-1"))
sim13 <- rma(d, d_var, dat = filter(all_es, timing == "simultaneous", order == "1-3"))
sim31 <- rma(d, d_var, dat = filter(all_es, timing == "simultaneous", order == "3-1"))

ma_es <- data.frame(order = c("1-3", "3-1", "1-3", "3-1"),
           timing = c("sequential", "sequential", "simultaneous", "simultaneous"),
           d = c(seq13$b[[1]], seq31$b[[1]], sim13$b[[1]], sim31$b[[1]]),
           d_low = c(seq13$ci.lb[[1]], seq31$ci.lb[[1]], sim13$ci.lb[[1]], sim31$ci.lb[[1]]),
           d_high = c(seq13$ci.ub[[1]], seq31$ci.ub[[1]], sim13$ci.ub[[1]], sim31$ci.ub[[1]]))
```

```{r fig.width=5.5, fig.height=3.5, fig.cap = "Cumulative plot of effect sizes for all 19 studies conducted on the suspicious coincidence effect by XT (Xu & Tenenbaum, 2007a), SPSS (Spencer, et al, 2011), and the current authors. The top-bottoom facets indicate whether the single exemplar trial occurred first (1-3) or second (3-1). The left-right facets  indicate whether the exemplars were presented simulateously as in XT or sequentially as in SPSS. Point color indicates whether the single exemplar and three subordinate exemplars received the same (grey) or different (black) label. Point shape indicates whether trials were blocked by category (circle) or pseudo-random (triangle). Points are jittered along the x-axis for visibility. The red line reflects the meta-analytic estimate of the effect size (SD are estimated for XT experiments using SPSS replications). All error bars are 95% confidence intervals."}

ggplot(all_es) +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = d_low, ymax = d_high), 
            fill = "red", alpha = 0.05, inherit.aes = FALSE, data = ma_es) +
  geom_hline(aes(yintercept = d), data = ma_es, color = "red") +
  scale_color_manual(values = c("black","grey63")) +
  geom_pointrange(aes(x = jitter(source, 1.5),  y = d, ymax = high, 
                      ymin = low, color = one_3sub_label, shape = fct_rev(blocking)), 
                  size = .5) +
  geom_hline(yintercept = 0, linetype = 2, color = "black") +
  facet_grid(order ~ timing) +
  scale_x_continuous(breaks = c(1:3), limits = c(.6, 3.3),
                     labels = c("XT","SPSS","LF")) +
  ylab("Cohen's d") +
  xlab("Paper") + 
  guides(color = guide_legend("Label"),
         shape = guide_legend("Blocking"))  +
  ggthemes::theme_few() 
```

```{r}
mod <- rma(d ~ timing + order + one_3sub_label + blocking, d_var, dat = all_es)

mod_df <- data.frame(fixed_effect = c("Intercept", 
                                        "Simultaneous vs. sequential timing", 
                                        "1-3 vs. 3-1 condition order",
                                        "Different vs. same label", 
                                        "Blocked vs. random trial order"),
                      beta_string = paste0(round(mod$beta, 2), 
                                        " [", round(mod$ci.lb, 2), ", "
                                  , round(mod$ci.ub,2) , "]"),
                      zval = mod$zval,
                      pval_string = round(mod$pval, 2)) %>%
          mutate(pval_string = ifelse(pval_string == 0, "<.0001", pval_string))

kable(mod_df, caption = "Meta-analytic model with manipulations as fixed effects.",
      align = c('l', 'r', 'r', 'r'), digits = 2,
      col.names = c("Fixed effect", "beta", "z-value", "p-value"),
      format = "latex", booktabs = TRUE)  %>%
      kable_styling(font_size = 12) 
```

# Discussion

\newpage

# References
```{r create_r-references}
r_refs(file = "r-references.bib")
```

\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}
