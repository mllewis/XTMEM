---
title: 'Still suspicious: The suspicious coincidence effect revisited'
author: "Molly Lewis"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: yes
    theme: cerulean
    toc: yes
    toc_float: no
runtime: shiny
subtitle: Supplementary Information
resource_files:
- data/munged_data/exp1_data_munged.csv
- data/munged_data/exp2_data_munged.csv
- data/munged_data/exp3_data_munged.csv
- data/munged_data/exp4_data_munged.csv
- data/munged_data/exp5_data_munged.csv
- data/munged_data/exp6_data_munged.csv
- data/munged_data/exp7_data_munged.csv
- data/munged_data/exp8_data_munged.csv
- data/munged_data/exp9_data_munged.csv
- data/munged_data/exp10_data_munged.csv
- data/munged_data/exp11_data_munged.csv
- data/munged_data/exp12_data_munged.csv
---
  
******
******

```{r setup, include = F}
rm(list = ls())

# load packages
library(knitr)
library(rmarkdown)
library(broom)
library(tidyverse) 
library(langcog)
library(forcats)
library(compute.es)
library(stringr)
library(metafor)
library(kableExtra)
library(shiny)

opts_chunk$set(echo = T, message = F, warning = F, 
               error = F, cache = F, tidy = F, fig.height = 4)
```  

```{r read_in_anon_data}
files <- c("exp1_data_munged.csv", "exp10_data_munged.csv", "exp11_data_munged.csv", "exp12_data_munged.csv", "exp2_data_munged.csv" , "exp3_data_munged.csv", "exp4_data_munged.csv"  ,"exp5_data_munged.csv", "exp6_data_munged.csv" , "exp7_data_munged.csv" ,
"exp8_data_munged.csv",  "exp9_data_munged.csv") 
all_d <- data.frame()
for (i in 1:length(files)) {
    s <- read_csv(paste0("data/munged_data/", files[i]))
    all_d <- bind_rows(all_d, data.frame(s))
}

exp_key <- read_csv("data/experiment_key.csv") %>%
              mutate(order = gsub("\"", "", order))
```

```{r}
exp_table <- exp_key %>%
  slice(1:12) %>%
  mutate(direct_replication_of_string = ifelse(is.na(direct_replication_of),
                                              "", direct_replication_of),
        blocking = str_replace_all(blocking, "random", "pseudo-random"),
         one_3sub_label = str_replace_all(one_3sub_label, "different", "diff."),
         exp_recoded = as.numeric(exp_recoded)) %>%
  select(exp_recoded, timing, order, blocking, 
          one_3sub_label, direct_replication_of_string) %>%
  arrange(exp_recoded)
```
# Effect size calculation
The classical Cohen's *d* measure was originally developed for between-subject designs and, as such, researchers have adapted the measure to within-subject designs in a variety of ways (http://jakewestfall.org/blog/index.php/category/effect-size/). We calculate our effect sizes using the "classic" Cohen's *d* formula, which takes the mean difference between conditions divided by the pooled standard deviation. Because this method does not take into account the fact that the means are within-subject, these are conservative estimates of effect size (since within-subject designs have more power). We use the `mes` function from the `compute.es` package to calculate our effect sizes. 

# All conditions and measures
In the Main Text, we report the proportion basic level selections for two training conditions, one-subordinate and three-subordinate. Here we report the data for all four conditions, for all three dependent measures (proportion basic level, subordinate level, and superordinate selections). Ranges are bootstrapped 95% confidence intervals.

```{r}
all_plot_data <- all_d %>%
  gather(variable, value, c(prop_sub, prop_bas, prop_sup)) %>%
  group_by(exp, condition, variable) %>%
  mutate(value = as.numeric(value)) %>%
  #multi_boot_standard(column = "value")  %>%
  summarise(mean = mean(value), 
            error = qt(0.975,df=n()-1)*sd(value)/sqrt(n()),
            ci_lower = mean - error,# FIXME to bootstrap
            ci_upper = mean + error) %>%
  ungroup() %>%
  mutate(variable = as.factor(variable),
         exp = as.character(exp),
        condition = fct_recode(condition, "1 sub." = "one",
                                          "3 basic"= "three_basic",
                                          "3 sub." = "three_subordinate",
                                          "3 super." = "three_superordinate"),
          variable = fct_recode(variable, "basic" = "prop_bas",
                                          "subordinate"= "prop_sub",
                                          "superordinate" = "prop_sup")) %>%
  left_join(exp_key %>% select(exp, exp_recoded))
```

```{r, echo = FALSE}
shinyApp(
  
  ui = fluidPage(
    selectInput("expnum", "Select experiment number:", 
                choices = as.character(1:12), width = '25%'),
    wellPanel(htmlOutput("exp_description")),
    plotOutput("all_measures_plot")
  ),
  
  server = function(input, output) {
    
    output$exp_description <- renderText({
        desc <- filter(exp_key, exp_recoded == input$expnum)
        description_string <- paste0("<b>Timing:</b> ", desc$timing[[1]],
                                     ",     <b>Trial order:</b> ", desc$order[[1]],
                                     ",     <b>Blocking:</b> ", desc$blocking[[1]],
                                     ",     <b>Label:</b> ", desc$one_3sub_label[[1]])
        description_string
        
        HTML(paste(description_string))
    })
    
    output$all_measures_plot <- renderPlot({
      
    all_plot_data %>%
      filter(exp_recoded == input$expnum) %>%
      ggplot(aes(x = condition, y = mean, group = variable, fill = variable)) +
      geom_bar(position = "dodge", stat = "identity") +
      geom_linerange(aes(ymin = ci_lower, 
                     ymax = ci_upper), 
                 position = position_dodge(width = .9)) +
      ylab("Proportion of objects selected") +
      xlab("Learning exemplars") +
      guides(fill=guide_legend(title="Object type")) +
      theme_bw() +
              theme(text = element_text(size = 17)) +

      ggtitle(paste0("Experiment #", input$expnum))
    })
  },
  
  options = list(height = 600)
)
```

#  By category analyses
In the Main Text, we report our analyses collapsed across all three stimulus categories (animals, vehicles and vegtables). Here we present the effect sizes for each experiment separately for the different stimulus categories. While there is some variability in effect size by category (the effect is larger for animals), this variability is small relative to the effect of condition order. Ranges are 95% confidence intervals.

```{r get_means}
# remap condition values and select relevant conditions
all_d_clean <- all_d %>%
      mutate(condition = as.factor(condition),
             exp = as.character(exp),
             condition = fct_recode(condition,
                                     three_basic = "3bas",
                                     three_subordinate = "3sub",
                                     three_superordinate = "3sup")) %>%
      filter(condition == "one" | condition == "three_subordinate") %>%
      select(exp, everything())

all_ms_subj2 <- all_d_clean %>%
  left_join(exp_key %>% select(exp, exp_recoded)) %>%
  select(-exp) %>%
  gather(variable, value, c(prop_sub, prop_bas, prop_sup))  %>%
  group_by(condition, category, variable, exp_recoded, subids) %>%
  mutate(value = as.numeric(value)) %>%
  summarize(value = mean(value)) %>%
filter(condition == "one" | condition == "three_subordinate",
         variable == 'prop_bas') %>%
  spread(condition, value) %>%
  ungroup()  %>%
  select(-variable)

LF_means2 <- all_ms_subj2 %>%
  group_by(exp_recoded, category) %>%
  summarize(m_one = mean(one),
            sd_one = sd(one),
            m_3sub = mean(three_subordinate),
            sd_3sub = sd(three_subordinate),
            n = n())

LF_effect_sizes2<- LF_means2 %>%
  ungroup() %>%
  do(data.frame(d = mes(.$m_one, .$m_3sub, .$sd_one,
                     .$sd_3sub, .$n, .$n, verbose = F)$d,
               d_var = mes(.$m_one, .$sd_3sub, .$sd_one,
                    .$sd_3sub, .$n, .$n, verbose = F)$var.d)) %>%
  mutate(high = d + (1.96*d_var),
         low = d - (1.96*d_var),
         es_type = "nonpaired",
         exp_recoded = LF_means2$exp_recoded,
         category = LF_means2$category) 

```

```{r, echo = FALSE}
shinyApp(
  
  ui = fluidPage(
    selectInput("expnum", "Select experiment number:", 
                choices = as.character(1:12), width = '30%'),
    wellPanel(htmlOutput("exp_description")),
    
    
    plotOutput("by_category_plot")
  ),
  
  server = function(input, output) {
    
    output$exp_description <- renderText({
        desc <- filter(exp_key, exp_recoded == input$expnum)
        description_string <- paste0("<b>Timing:</b> ", desc$timing[[1]],
                                     ",     <b>Trial order:</b> ", desc$order[[1]],
                                     ",     <b>Blocking:</b> ", desc$blocking[[1]],
                                     ",     <b>Label:</b> ", desc$one_3sub_label[[1]])
        description_string
        
        HTML(paste(description_string))
    })
    
    output$by_category_plot <- renderPlot({

    LF_effect_sizes2 %>%
      filter(exp_recoded == input$expnum) %>%
      ggplot(aes(x = category, y = d)) +
      geom_hline(yintercept = 0, linetype = 2, color = "black",size = 1.1) +
        geom_pointrange(size = 1.2, aes(ymax = high, ymin = low, color = category)) +
        ggtitle("Effect size (Cohen's d) by category") +
        ylim(-.5, 1.7)+
        ylab("Cohen's d") +
        ggthemes::theme_few()  +
        theme(text = element_text(size = 17),
              legend.position = "none") +
        ggtitle(paste0("Experiment #", input$expnum))
    })
  },
  
  options = list(width = "70%", height = 600)
)
```


# Repeat participants excluded
```{r}
all_d_filtered <- read_csv("data/munged_data/all_data_munged_A.csv")

n_unique <- all_d_filtered %>%
  distinct(exp, subids) %>%
  summarize(n = n())

n_total <- all_d %>%
  distinct(exp, subids) %>%
  summarize(n = n())
  
percent_duplicates <- round((n_total-n_unique)/n_total, 2) * 100
```
`r percent_duplicates`% of  all participants (N = `r n_total`) completed more than one experiment. The data reported in the main text include all participants. Below we plot the effect sizes with participants who had already participanted in a prior experiment excluded (effect size estimates from XT and SPSS are also included for reference). The overall pattern looks the same as with all participants.

```{r, fig.height = 5, fig.width = 7}
all_d_clean <- all_d_filtered %>%
      mutate(condition = as.factor(condition),
             exp = as.character(exp),
             condition = fct_recode(condition,
                                     three_basic = "3bas",
                                     three_subordinate = "3sub",
                                     three_superordinate = "3sup")) %>%
      filter(condition == "one" | condition == "three_subordinate") %>%
      select(exp, everything())

all_ms_subj <- all_d_clean %>%
  left_join(exp_key %>% select(exp, exp_recoded)) %>%
  select(-exp) %>%
  gather(variable, value, c(prop_sub, prop_bas, prop_sup)) %>%
  group_by(condition,variable, exp_recoded, subids) %>%
  mutate(value = as.numeric(value)) %>%
  summarize(value = mean(value)) %>%
  filter(condition == "one" | condition == "three_subordinate", 
         variable == 'prop_bas') %>%
  spread(condition, value) %>%
  ungroup() %>%
  select(-variable)

# get effect sizes
LF_means <- all_ms_subj %>%
  group_by(exp_recoded) %>%
  summarize(m_one = mean(one),
            sd_one = sd(one),
            m_3sub = mean(three_subordinate),
            sd_3sub = sd(three_subordinate),
            n = n())

LF_effect_sizes <- LF_means %>%
  do(data.frame(d = mes(.$m_one, .$m_3sub, .$sd_one,
                     .$sd_3sub, .$n, .$n, verbose = F)$d,
               d_var = mes(.$m_one, .$sd_3sub, .$sd_one,
                    .$sd_3sub, .$n, .$n, verbose = F)$var.d)) %>%
  mutate(high = d + (1.96*d_var),
         low = d - (1.96*d_var),
         es_type = "nonpaired",
         exp_recoded = LF_means$exp_recoded) %>%
  left_join(LF_means %>% select(exp_recoded, n)) %>%
  select(exp_recoded, n, everything())

literature_effect_sizes <- read_csv("data/literature_ES.csv") # see ../../analysis/get_literature_ES.R

all_es <- literature_effect_sizes %>%
            bind_rows(LF_effect_sizes) %>%
            left_join(exp_key) %>%
            mutate(source = ifelse(str_detect(exp_recoded, "XT"), "XT2007a", 
                               ifelse(str_detect(exp_recoded, "SPSS"), "SPSS2011", "LF")), 
                   source = fct_relevel(source, "XT2007a","SPSS2011","LF"),
                   source = as.numeric(source),
                   timing = fct_relevel(timing,"simultaneous", "sequential"))

seq13 <- rma(d, d_var, dat = filter(all_es, timing == "sequential", order == "1-3"))
seq31 <- rma(d, d_var, dat = filter(all_es, timing == "sequential", order == "3-1"))
sim13 <- rma(d, d_var, dat = filter(all_es, timing == "simultaneous", order == "1-3"))
sim31 <- rma(d, d_var, dat = filter(all_es, timing == "simultaneous", order == "3-1"))

ma_es <- data.frame(order = c("1-3", "3-1", "1-3", "3-1"),
           timing = c("sequential", "sequential", "simultaneous", "simultaneous"),
           d = c(seq13$b[[1]], seq31$b[[1]], sim13$b[[1]], sim31$b[[1]]),
           d_low = c(seq13$ci.lb[[1]], seq31$ci.lb[[1]], sim13$ci.lb[[1]], sim31$ci.lb[[1]]),
           d_high = c(seq13$ci.ub[[1]], seq31$ci.ub[[1]], sim13$ci.ub[[1]], sim31$ci.ub[[1]]))

ggplot(all_es) +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = d_low, ymax = d_high), 
            fill = "red", alpha = 0.05, inherit.aes = FALSE, data = ma_es) +
  geom_hline(aes(yintercept = d), data = ma_es, color = "red") +
  scale_color_manual(values = c("black", "grey63")) +
  geom_pointrange(aes(x = jitter(source, 1.4),  y = d, ymax = high, 
                      ymin = low, color = one_3sub_label, shape = fct_rev(blocking)), 
                  size = .5) +
  geom_hline(yintercept = 0, linetype = 2, color = "black") +
  facet_grid(order ~ timing) +
  scale_x_continuous(breaks = c(1:3), limits = c(.6, 3.3),
                     labels = c("XT","SPSS","LF")) +
  ylab("Cohen's d") +
  xlab("Paper") + 
  guides(color = guide_legend("Label"),
         shape = guide_legend("Blocking"))  +
  ggthemes::theme_few()

```
---> add meta-analytic model

# Demographics{.tabset}
```{r}
raw_files <- dir("data/anonymized_raw_data/")
raw_d <- data.frame()
for (i in 1:length(raw_files)[1]) {
    s <- read_csv(paste0("data/anonymized_raw_data/", raw_files[i])) %>%
        mutate(exp = unlist(str_split(files[i], "_|exp"))[2]) %>%
        select(exp, subids, SubmitTime, AcceptTime,
               asses, comments, age, gender, education, enjoyment, language)
    raw_d <- bind_rows(raw_d, data.frame(s))
}

raw_d_munged <- raw_d %>%
  left_join(exp_key %>% select(exp, exp_recoded, timing)) %>%
  mutate(exp_recoded = fct_relevel(exp_recoded, "10", after = 11),
         exp_recoded = fct_relevel(exp_recoded, "11", after = 11),
         exp_recoded = fct_relevel(exp_recoded, "12", after = 11)) %>%
  select(-exp) %>%
  ungroup()
```

## Education
```{r}
raw_d_munged %>%
  mutate(education = as.factor(education),
         education = fct_recode(education,
                        "No Response" = "-1",
                        "Some High School" = "0",
                        "Graduated High School" = "1",
                        "Some College"= "2",
                        "Graduated College" = "3",
                        "Hold a higher degree" = "4")) %>%
  group_by(education) %>%
  summarise(n = n()) %>%
  mutate(prop = round(n / sum(n),2)) %>%
  kable()
```

## First language
```{r}
raw_d_munged %>%
  mutate(language = tolower(language),
         language = ifelse(substr(language,0,1) == "e", # all e lanuages are english
                           "English", "Other")) %>%
  group_by(language) %>%
    summarise(n = n()) %>%
  mutate(prop = round(n / sum(n),2)) %>%
  kable()
```

## Gender
```{r}
raw_d_munged %>%
  group_by(gender) %>%
  summarise(n = n()) %>%
  mutate(prop = round(n / sum(n),2)) %>%
  kable()
```

## Age
```{r}

raw_d_munged %>%
  mutate(age = as.numeric(as.character(age))) %>%
  ggplot(aes(x = age)) +
  geom_histogram() +
  geom_vline(aes(xintercept = mean(as.numeric(as.character(age)),
                                   na.rm = T)), 
                 color = "red") +
  xlab("Age (years)") +
  theme_bw() +
  ggtitle("Age distribution")
```

# Task feedback{.tabset}

## Enjoyment
```{r}
raw_d_munged %>%
  mutate(enjoyment = as.factor(enjoyment),
         enjoyment = fct_recode(enjoyment,
                        "No Response" = "-1",
                        "Worse than the Average HIT" = "0",
                        "An Average HIT" = "1",
                        "Better than average HIT" = "2")) %>%
  group_by(enjoyment) %>%
  summarise(n = n()) %>%
  mutate(prop = round(n / sum(n),2)) %>%
  kable()
```

## Understanding
```{r}
raw_d_munged %>%
  mutate(asess = as.factor(asses)) %>%
  rename(`Did you read instructions?` = "asses") %>%
  group_by(`Did you read instructions?`) %>%
  summarise(n = n()) %>%
  mutate(prop = round(n / sum(n),2)) %>%
  kable()

#unique(raw_d_munged$comments)
```

# Task time
Task times were variable across experiments, but overall shorter for simultaneous timing experiments (green) compared to sequential (pink).
```{r}
# fix this - dplyr doesn't play well with dates
raw_d_mungedT <- raw_d_munged

raw_d_mungedT$SubmitTime = gsub("T|Z","",raw_d_mungedT$SubmitTime)
raw_d_mungedT$AcceptTime = gsub("T|Z","",raw_d_mungedT$AcceptTime)
raw_d_mungedT$SubmitTime = strptime(raw_d_munged$SubmitTime, "%F%T")
raw_d_mungedT$AcceptTime = strptime(raw_d_mungedT$AcceptTime, "%F%T")
raw_d_mungedT$total_time = as.numeric(raw_d_mungedT$SubmitTime) - as.numeric(raw_d_mungedT$AcceptTime)

ggplot(raw_d_mungedT, 
       aes(x = exp_recoded, y = total_time/60, fill = timing)) +
    ylab("Time (min.)") +
    xlab("Experiment") +
    ggtitle("Task time")+
    geom_boxplot() +
    ggthemes::theme_few()  
```

