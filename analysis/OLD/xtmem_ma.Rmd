---
title: XTMEM
subtitle: Meta-analysis of experiments
author: Molly Lewis 
date: "`r Sys.Date()`"
output: 
  html_document:
    number_sections: false
    theme: cerulean
    toc_float: true
    toc: true
    code_folding: show
---
  
******
******


```{r setup, include = F}
rm(list=ls())

# load packages
library(knitr)
library(rmarkdown)
library(broom)
library(tidyverse) 
library(langcog)
library(jsonlite)
library(stringr)
library(png)
library(grid)
library(forcats)
library(effsize)
library(compute.es)

source("useful_ML.R")

opts_chunk$set(echo = T, message = F, warning = F, 
               error = F, cache = F, tidy = F, fig.height = 4)
```  

## Reproduce SPSS Fig. 3
(plotting proportion basic level)

Read in all previous data and bind to current dataset
```{r}
files = dir("../data/")
all.d = data.frame()
for (i in 1:length(files)[1]) {
    s <- read.csv(paste0("../data/", files[i]))
    all.d = bind_rows(all.d, data.frame(s))
}

exp_key = read.csv("experiment_key.csv")
```

Get means and plot
```{r, fig.height = 6, fig.cap = "same vs. different refers to whether the one and 3 subordinate trials recieved the same lable. 3--1 and 1--3 refers to the relative order of the one and 3 subordinate trials."}
all.d$condition = plyr::mapvalues(all.d$condition,
                               from = c("one", "3bas", "3sub", "3sup"), 
                               to = c("one", "three_basic", 
                                        "three_subordinate",
                                        "three_superordinate"))
all.d$condition = as.factor(all.d$condition)

all.ms = all.d %>%
  gather(variable, value, c(prop_sub, prop_bas, prop_sup)) %>%
  group_by(condition,variable, exp, subids) %>%
  mutate(value = as.numeric(value)) %>%
  summarize(value = mean(value)) %>%
  group_by(condition,variable, exp) %>%
  #multi_boot_standard(column = "value")  %>% 
   summarise(mean = mean(value)) %>%
  ungroup() %>%
  mutate(variable = as.factor(variable)) %>%
  filter(condition == "one" | condition == "three_subordinate") %>%
  filter(variable == "prop_bas") %>%
  mutate(exp = as.factor(exp)) %>%
  left_join(exp_key) 
  
ggplot(all.ms, aes(x = exp, y = mean, group = condition, fill = condition)) +
  geom_bar(position = "dodge", stat = "identity") +
  geom_linerange(aes(ymin = summary_ci_lower, 
                     ymax = summary_ci_upper), 
                 position=position_dodge(width = .9)) +
  facet_grid(order * one_3sub_label ~ timing) +
  ylim(0,1)+
  ylab("Proportion basic-level choices ") +
  xlab("Experiment") +
  theme_bw() +
  theme(legend.title = element_blank())
```

## Plot effect size
Get effect sizes of our experiments. 
```{r}
all.ms.subj = all.d %>%
  gather(variable, value, c(prop_sub, prop_bas, prop_sup)) %>%
  group_by(condition,variable, exp, subids) %>%
  mutate(value = as.numeric(value)) %>%
  summarize(value = mean(value)) %>%
  filter(condition == "one" | condition == "three_subordinate", variable == 'prop_bas') %>%
  spread(condition, value) %>%
  ungroup () %>%
  select(-variable)

effect.sizes.npaired  = all.ms.subj %>%
  group_by(exp) %>%
  summarize(m.one = mean(one),
            sd.one = sd(one),
            m.3sub = mean(three_subordinate),
            sd.3sub = sd(three_subordinate),
            n= n()) %>%
  do(data.frame(d = mes(.$m.one, .$m.3sub, .$sd.one,
       .$sd.3sub, .$n, .$n, verbose = F)$d,
       var.d = mes(.$m.one, .$m.3sub, .$sd.one,
       .$sd.3sub, .$n, .$n, verbose = F)$var.d))%>%
  mutate(high = d + (1.96*var.d),
         low = d - (1.96*var.d),
         es.type = "nonpaired",
         exp = as.numeric(c(1:10)))  # fix this

effect.sizes = effect.sizes.npaired %>%
  mutate(n = 50, 
         exp = as.factor(exp)) 
```

Calculate effect sizes from previous experiments. Here are the means and sd based on SPSS table 1.
```{r}
original.effect.sizes = data.frame(exp = c("XT_adults_e1", "XT_children_e2",
                        "SPSS_e1",
                        "SPSS_e2",
                        "SPSS_e3",
                        "SPSS_eS1",
                        "SPSS_eS2"),
                        one_means = c(76, 40, 48.24, 30.83, 39.91, 24.56, 15.79), 
                        three_means = c(9, 6, 10.53, 53.33, 51.75, 16.67, 11.40),
                        one_sd = c(40.40, 40.40, 40.40,37.18,35.20,32.09,24.51),
                        three_sd = c(24.97, 24.97, 24.97,36.11,42.63,25.45,24.25),
                        n = c(22, 36, 19, 20, 19,19,19))
kable(original.effect.sizes)
```

Calculate previous effect sizes
```{r}
original.effect.sizes$d = mes(original.effect.sizes$one_means/100,
                              original.effect.sizes$three_means/100, 
                              original.effect.sizes$one_sd/100,
                              original.effect.sizes$three_sd/100,
                              original.effect.sizes$n,
                              original.effect.sizes$n, verbose = F)$d

original.effect.sizes$d_var = mes(original.effect.sizes$one_means/100,
                                  original.effect.sizes$three_means/100,
                                  original.effect.sizes$one_sd/100,
                                  original.effect.sizes$three_sd/100,
                                  original.effect.sizes$n, 
                                  original.effect.sizes$n,
                                  verbose = F)$var.d

original.effect.sizes = original.effect.sizes %>%
                            mutate(high = d + (1.96*d_var),
                                     low = d - (1.96*d_var)) %>%
                            select(-one_means, -three_means, -one_sd, -three_sd) %>%
                            mutate(es.type = "nonpaired")
```

Bind previous and current effect sizes together and plot
```{r, fig.height = 7, fig.cap = "same vs. different refers to whether the one and 3 subordinate trials recieved the same lable. 3--1 and 1--3 refers to the relative order of the one and 3 subordinate trials."}
all.es =  original.effect.sizes %>%
            bind_rows(effect.sizes) %>%
            left_join(exp_key)


ggplot(all.es, aes(x = exp, y = d)) +
  geom_point(color = "red", size = 2)+
  geom_linerange(aes(ymax =high, ymin=low),
                 position = position_dodge(width = 0), color = "red") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_grid(order * one_3sub_label ~ timing, drop = TRUE, scales = "free_y")+
  coord_flip() +
  geom_hline(yintercept = 0, linetype = 2) +
  ggtitle("Effect size") +
  xlab("Experiment")
```

## Misc
### By category
```{r, fig.width = 9, fig.height = 3, include = F, eval = F}
ms4 = d4.munged %>%
  gather(variable, value, c(prop_sub, prop_bas, prop_sup)) %>%
  mutate(variable = as.factor(variable)) %>%
  group_by(condition,variable, category, subids) %>%
  mutate(value = as.numeric(value)) %>%
  summarize(value = mean(value))%>%
  group_by(condition,variable,category) %>%
  multi_boot_standard(column = "value") 

ms4$variable = factor(ms4$variable,levels(ms4$variable)[c(2,1,3)])
ms4$condition = factor(ms4$condition,levels(ms4$condition)[c(4,2,1,3)])
ms4$condition = plyr::mapvalues(ms4$condition,
 from = c("one", "3bas", "3sub",
                                        "3sup"), 
                               to = c("1", "3 basic", "3 sub.", "3 super."))

ggplot(ms4, aes(x = condition, y = mean, group = variable, fill = variable)) +
  facet_grid(~category) +
  geom_bar(position = "dodge", stat = "identity") +
  geom_linerange(aes(ymin = summary_ci_lower, 
                     ymax = summary_ci_upper), 
                 position=position_dodge(width = .9)) +
  ylab("Proportion of \ntest objects chosen") +
  xlab("Examples") +
  theme_bw() +
  theme(legend.title = element_blank())
```

### Post-task questions
```{r,  include = F,  eval = F}
d4 %>%
  group_by(education) %>%
  summarise(n = n()) %>%
  kable()

d4 %>%
  group_by(enjoyment) %>%
  summarise(n = n()) %>%
  kable()

d4 %>%
  mutate(language = tolower(language)) %>%
  group_by(language) %>%
  summarise(n = n()) %>%
  kable()

d4 %>%
  group_by(gender) %>%
  summarise(n = n()) %>%
  kable()

d4 %>%
  group_by(asses) %>%
  summarise(n = n()) %>%
  kable()

d4 %>%
  mutate(age = as.numeric(as.character(age))) %>%
  ggplot(aes(x= age)) +
  geom_histogram() +
  theme_bw() +
  ggtitle("Age distribution")

unique(d4$comments)
```


### Task time
```{r, fig.height = 5, include = F,  eval = F}
d1 = read.csv("../../exp1/analysis/exp1_A.csv" ) %>%
      mutate(exp = "XT2007a replication (E1)")
d2 = read.csv("../../exp2/analysis/exp2_A.csv" ) %>%
      mutate(exp = "SPSS replication (E2)")
d3 = read.csv("../../exp3/analysis/exp3_A.csv" ) %>%
      mutate(exp = "XT2007a replication (E3), blocked/diff labels")
d4 = mutate(d4, exp = "SPSS replication (E4), blocked/diff labels")

all = rbind(d1, d2, d3, d4)

all$SubmitTime = gsub("T|Z","",all$SubmitTime)
all$AcceptTime = gsub("T|Z","",all$AcceptTime)
all$SubmitTime = strptime(all$SubmitTime, "%F%T")
all$AcceptTime = strptime(all$AcceptTime, "%F%T")
all$total_time = as.numeric(all$SubmitTime) - as.numeric(all$AcceptTime)
all$exp = as.factor(all$exp)
all$exp = factor(all$exp,levels(all$exp)[c(3,4,1,2)])

ggplot(all, aes(x = exp, y = total_time/60)) +
    ylab("Task time (min)") +
    geom_boxplot() +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

all %>%
  select(-AcceptTime, -SubmitTime) %>%
  group_by(exp) %>%
  mutate(total_time = total_time/60) %>%
  multi_boot_standard(column = "total_time") %>%
  ggplot(aes(x = exp, y = mean, fill = exp)) +
  geom_bar(position = "dodge", stat = "identity") +
  geom_linerange(aes(ymin = summary_ci_lower, 
                     ymax = summary_ci_upper), 
                 position=position_dodge(width = .9)) +
  ylab("Task time (min)") +
  xlab("Examples") +
  theme_bw() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Duplicates
TO DO: look at ES excluide duplicates (about 10%)
```{r, include = F,  eval = F}
NUMEXPS <- 8

d = data.frame()
for (j in 1:NUMEXPS){
  files = dir(paste0("../experiments/exp", as.character(j), "/production-results/"))
  for (i in 1:length(files)[1]) {
      s <- fromJSON(paste0("../experiments/exp", as.character(j), "/production-results/", files[i]))
      s$exp = j
      s$answers$asses = ifelse(is.null(s$answers$asses), "NA", s$answers$asses)
      d = bind_rows(d, data.frame(s))
  }
}
names(d) <- str_replace(names(d), "answers.", "")

d$WorkerId = as.factor(d$WorkerId)

hit.counts = group_by(d, WorkerId) %>%
  summarize(count = n()) %>%
  arrange(-count) %>%
  filter(count > 1) %>%
  left_join(select(d, WorkerId, exp))

good.hits = hit.counts %>%
  group_by(WorkerId) %>%
  mutate(first_exp = min(exp),
         include = as.factor(ifelse(exp == first_exp, "keep", "remove"))) 
```

