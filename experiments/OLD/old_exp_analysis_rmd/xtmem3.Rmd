---
title: XTMEM3
subtitle: 
author: Molly Lewis 
date: "`r Sys.Date()`"
output: 
  html_document:
    number_sections: false
    theme: cerulean
    toc_float: true
    code_folding: show
---
  
******
******

Replication of XT2007a with 2 methodological modifications (follwing SPSS11): Blocking and reordering of trials (sub first), and using different label for all 12 trials. 

```{r setup, include = F}
rm(list=ls())

# load packages
library(knitr)
library(rmarkdown)
library(broom)
library(tidyverse) 
library(langcog)
library(jsonlite)
library(stringr)
library(png)
library(grid)
library(forcats)

source("../../../analysis/useful_ML.R")


opts_chunk$set(echo = T, message = F, warning = F, 
               error = F, cache = F, tidy = F, fig.height = 4)

```  

### Read in raw data and anonymize

```{r, constants}
EXPTNUM <- 3
a.data.filename <- paste0("exp", EXPTNUM, "_A.csv")
```

```{r, eval = F}
files = dir("../production-results/")
d = data.frame()
for (i in 1:length(files)[1]) {
    s <- fromJSON(paste("../production-results/", files[i], sep = ""))
    s$answers$asses = ifelse(is.null(s$answers$asses), "NA", s$answers$asses)
    d = bind_rows(d, data.frame(s))
}
names(d) <- str_replace(names(d), "answers.", "")
d.anonymized <- anonymize.sids(d, "WorkerId")

#write.csv(d.anonymized, a.data.filename)
```

### Munge
```{r}
d3 = read.csv(a.data.filename)

d3.long = d3 %>%
  gather(variable, value, contains("_")) %>%
  mutate(trial_num =  unlist(lapply(strsplit(as.character(variable),
                                      "_T"),function(x) x[2])),
         variable = unlist(lapply(strsplit(as.character(variable),
                                      "_"),function(x) x[1]))) %>%
  spread(variable, value) %>%
  mutate(trial_num = as.numeric(trial_num)) %>%
  mutate_if(is.character, funs(as.factor)) 

d3.munged = d3.long %>%
          select(subids, trial_num, category, condition, selected) %>%
          mutate(selected = lapply(str_split(selected, ","), 
                                   function(x) {str_sub(x, 4, 6)})) %>%
          mutate(prop_sub = unlist(lapply(selected, function(x){sum(x == "sub")/2})),
                 prop_bas = unlist(lapply(selected, function(x){sum(x == "bas")/2})),
                 prop_sup = unlist(lapply(selected, function(x){sum(x == "sup")/4}))) %>%
          select(-selected)
```

```{r, eval = F}
d3.munged$exp = EXPTNUM
#write.csv(d3.munged, paste0("../../../data/exp", EXPTNUM, "_data_munged.csv"), row.names = F)
```

### Reproduce XT2007a Figure 5.
```{r, fig.width = 8}
ms3 = d3.munged %>%
  gather(variable, value, c(prop_sub, prop_bas, prop_sup)) %>%
  group_by(condition,variable) %>%
  mutate(value = as.numeric(value)) %>%
  multi_boot_standard(column = "value")  %>%
  mutate(variable = as.factor(variable))

ms.plot <- ms3
ms.plot$variable = factor(ms.plot$variable,levels(ms.plot$variable)[c(2,1,3)])
ms.plot$condition = factor(ms.plot$condition,levels(ms.plot$condition)[c(4,2,1,3)])
ms.plot$condition = plyr::mapvalues(ms.plot$condition,
                               from = c("one", "3bas", "3sub",
                                        "3sup"), 
                               to = c("1", "3 basic", "3 sub.", "3 super."))

ggplot(ms.plot, aes(x = condition, y = mean, group = variable, fill = variable)) +
  geom_bar(position = "dodge", stat = "identity") +
  geom_linerange(aes(ymin = ci_lower, 
                     ymax = ci_upper), 
                 position=position_dodge(width = .9)) +
  ylab("Proportion of \ntest objects chosen") +
  xlab("Examples") +
  theme_bw() +
  theme(legend.title = element_blank())

```
Previous experiments plotted as by SPSS:

Read in all previous data and bind to current dataset
```{r}
files = dir("../../../data/")
all.d = data.frame()
for (i in 1:length(files)[1]) {
    s <- read.csv(paste0("../../../data/", files[i]))
    all.d = bind_rows(all.d, data.frame(s))
}
```

```{r}
all.d$condition = plyr::mapvalues(all.d$condition,
                               from = c("one", "3bas", "3sub", "3sup"), 
                               to = c("one", "three_basic", 
                                        "three_subordinate",
                                        "three_superordinate"))
all.d$condition = as.factor(all.d$condition)

all.ms = all.d %>%
  gather(variable, value, c(prop_sub, prop_bas, prop_sup)) %>%
  group_by(condition,variable, exp) %>%
  mutate(value = as.numeric(value)) %>%
  multi_boot_standard(column = "value")  %>%
  ungroup() %>%
  mutate(variable = as.factor(variable)) %>%
  filter(condition == "one" | condition == "three_subordinate") %>%
  filter(variable == "prop_bas")

ggplot(all.ms, aes(x = exp, y = mean, group = condition, fill = condition)) +
  geom_bar(position = "dodge", stat = "identity") +
  geom_linerange(aes(ymin = ci_lower, 
                     ymax = ci_upper), 
                 position=position_dodge(width = .9)) +
  ylim(0,1)+
  ylab("Proportion basic-level choices ") +
  xlab("Experiment") +
  theme_bw() +
  theme(legend.title = element_blank())
```

### By category
```{r, fig.width = 9, fig.height = 3}
ms3 = d3.munged %>%
  gather(variable, value, c(prop_sub, prop_bas, prop_sup)) %>%
  mutate(variable = as.factor(variable)) %>%
  group_by(condition,variable,category) %>%
  mutate(value = as.numeric(value)) %>%
  multi_boot_standard(column = "value") 

ms3$variable = factor(ms3$variable,levels(ms3$variable)[c(2,1,3)])
ms3$condition = factor(ms3$condition,levels(ms3$condition)[c(4,2,1,3)])
ms3$condition = plyr::mapvalues(ms3$condition,
 from = c("one", "3bas", "3sub",
                                        "3sup"), 
                               to = c("1", "3 basic", "3 sub.", "3 super."))

ggplot(ms3, aes(x = condition, y = mean, group = variable, fill = variable)) +
  facet_grid(~category) +
  geom_bar(position = "dodge", stat = "identity") +
  geom_linerange(aes(ymin = ci_lower, 
                     ymax = ci_upper), 
                 position=position_dodge(width = .9)) +
  ylab("Proportion of \ntest objects chosen") +
  xlab("Examples") +
  theme_bw() +
  theme(legend.title = element_blank())
```

### Post-task questions
```{r}
d3 %>%
  group_by(education) %>%
  summarise(n = n()) %>%
  kable()

d3 %>%
  group_by(enjoyment) %>%
  summarise(n = n()) %>%
  kable()

d3 %>%
  mutate(language = tolower(language)) %>%
  group_by(language) %>%
  summarise(n = n()) %>%
  kable()

d3 %>%
  group_by(gender) %>%
  summarise(n = n()) %>%
  kable()

d3 %>%
  group_by(asses) %>%
  summarise(n = n()) %>%
  kable()

d3 %>%
  mutate(age = as.numeric(as.character(age))) %>%
  ggplot(aes(x= age)) +
  geom_histogram() +
  theme_bw() +
  ggtitle("Age distribution")

unique(d3$comments)
```

### Task time

Just as a sanity check look at total task time: Expect participants to take longer in the SPSS experiment since its sequential. The data look consistent with ths.
```{r}
d1 = read.csv("../../exp1/analysis/exp1_A.csv" ) %>%
      mutate(exp = "XT2007a replication (E1)")
d2 = read.csv("../../exp2/analysis/exp2_A.csv" ) %>%
      mutate(exp = "SPSS replication (E2)")
d3 = mutate(d3, exp = "XT2007a replication (E3), blocked/diff labels")

all = rbind(d1, d2, d3)

all$SubmitTime = gsub("T|Z","",all$SubmitTime)
all$AcceptTime = gsub("T|Z","",all$AcceptTime)
all$SubmitTime = strptime(all$SubmitTime, "%F%T")
all$AcceptTime = strptime(all$AcceptTime, "%F%T")
all$total_time = as.numeric(all$SubmitTime) - as.numeric(all$AcceptTime)
all$exp = as.factor(all$exp)
all$exp = factor(all$exp,levels(all$exp)[c(2,3,1)])

ggplot(all, aes(x = exp, y = total_time/60)) +
    ylab("Task time (min)") +
    geom_boxplot() +
    theme_bw()

all %>%
  select(-AcceptTime, -SubmitTime) %>%
  group_by(exp) %>%
  mutate(total_time = total_time/60) %>%
  multi_boot_standard(column = "total_time") %>%
  ggplot(aes(x = exp, y = mean, fill = exp)) +
  geom_bar(position = "dodge", stat = "identity") +
  geom_linerange(aes(ymin = ci_lower, 
                     ymax = ci_upper), 
                 position=position_dodge(width = .9)) +
  ylab("Task time (min)") +
  xlab("Examples") +
  theme_bw() +
  theme(legend.position = "none")
```


